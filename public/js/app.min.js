/*! bitflopme 2013-11-25 */
var app=angular.module("app",["uiSlider"]);app.factory("socket",function(a){var b=io.connect(GLOBAL.URL,{reconnect:!0,"reconnection delay":500,"max reconnection attempts":10,"sync disconnect on unload":!0});return{on:function(c,d){b.on(c,function(){var c=arguments;a.$apply(function(){d.apply(b,c)})})},emit:function(c,d,e){b.emit(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b,c)})})},send:function(c,d,e){b.send(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b,c)})})},destroy:function(){b.removeAllListeners()}}}),app.directive("collapse",[function(){return{link:function(a,b,c){var d;a.$watch(c.collapse,function(a){a?f():e()});var e=function(){b.addClass("in"),d=!1},f=function(){d=!0,b.removeClass("in")}}}}]),app.filter("reverse",function(){return function(a){return a.slice().reverse()}}),app.directive("scrollGlue",function(){return{priority:1,require:"?ngModel",restrict:"A",link:function(a,b,c,d){d&&a.$watch(function(){d.$viewValue&&(b[0].scrollTop=0)})}}}),app.directive("localVideo",["socket",function(a){return{priority:1,restrict:"A",link:function(b,c){if(b.peer.local.element=c,null!==getUserMedia){var d=c[0];d&&(c.removeAttr("controls"),getUserMedia({video:!0,audio:!0},function(c){b.peer.local.stream=c,b.peer.connection.addStream(c),d.src=URL.createObjectURL(c),d.play(),b.media.available=!0,b.media.video=!0,b.media.audio=!0,b.$apply(),console.log("emit peer ready"),a.emit("peer:ready",{room:GLOBAL.ROOM})},function(){alert("There was an error connecting your webcam. Make sure it is not being used by any other applications.")}))}}}}]),app.directive("remoteVideo",["socket",function(){return{priority:1,restrict:"A",link:function(a,b){if(a.peer.remote.element=b,null!==getUserMedia){var c=b[0];c&&b.removeAttr("controls")}}}}]),app.controller("GameCtrl",function(a,b,c,d,e){if(b.isCollapsed=!0,null!==RTCPeerConnection){var f=new RTCPeerConnection({iceServers:[{url:"stun:stun.l.google.com:19302"}]});f.onicecandidate=function(a){a.candidate&&e.emit("peer:send_candidate",{room:GLOBAL.ROOM,candidate:a.candidate})},f.onaddstream=function(a){console.log("onaddstream called"),b.peer.remote.element&&(console.log(a),b.peer.remote.element.src=URL.createObjectURL(a.stream),b.peer.remote.element.play(),console.log(b.peer.remote.element),console.log("remote video should ow be playing"))}}var g={BET:{allowed:!1,min:0,max:0,amount:0},RAISE:{allowed:!1,min:0,max:0,amount:0},CALL:{allowed:!1,amount:0},FOLD:{allowed:!1}};b.initPeerConnection=function(){null!==RTCPeerConnection&&b.peer.connection.createOffer(function(a){b.peer.connection.setLocalDescription(a),console.log("send offer"),e.emit("peer:send_offer",{room:GLOBAL.ROOM,sdp:a})},null,{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}})},b.media={available:!1,audio:!1,video:!0},b.peer={connection:f||null,candidates:[],local:{},remote:{},connected:!1},b.room={id:-1,players:[],observers:[]},b.game={ready:!1,player:{id:-1,name:null,chips:null,cards:[],folded:null,options:g},opponent:{id:-1,name:null,chips:null,folded:null,cards:[]},events:[],action:null},b.fn={msToDateTime:function(a){var b=new Date(a);return b.toLocaleString()},parseAmount:function(a){return null===a||"undefined"==typeof a?0:parseInt(a,10)},toggleVideoStream:function(){b.peer.local.stream&&(b.media.video?(b.peer.local.stream.getVideoTracks()[0].enabled=!1,b.media.video=!1):(b.peer.local.stream.getVideoTracks()[0].enabled=!0,b.media.video=!0))},toggleAudioStream:function(){b.peer.local.stream&&(b.media.audio?(b.peer.local.stream.getAudioTracks()[0].enabled=!1,b.media.audio=!1):(b.peer.local.stream.getAudioTracks()[0].enabled=!0,b.media.audio=!0))}},b.action=function(a){var c={};switch(c.name=a,b.game.action.turn=null,b.game.options=g,c.name){case"BET":c.amount=parseInt(b.game.player.options.BET.amount,10);break;case"RAISE":c.amount=parseInt(b.game.player.options.RAISE.amount,10);break;case"FOLD":b.game.player.folded=!0}e.emit("player:action",{room:GLOBAL.ROOM,action:c})},e.on("connect",function(){e.emit("join",{room:GLOBAL.ROOM})}),e.on("disconnect",function(){e.emit("disconnect",{})}),e.on("game:join",function(a){console.log("game:join"),console.log(a),b.game.events=a.events,b.room.players=a.room.players,b.room.observers=a.room.observers,null!==a.player.id&&(b.game.ready=a.start,-1===b.game.player.id&&(b.game.player.id=a.player.id,b.game.player.name=a.user.name))}),e.on("game:data",function(a){console.log("game:data"),console.log(a),b.game.events=a.events,b.game.action=a.action,b.game.player=a.player,b.game.opponent=a.opponent}),e.on("game:end",function(a){console.log("game:end"),console.log(a),b.game.action=a.action,b.game.player=a.player,b.game.opponent=a.opponent}),e.on("game:leave",function(a){b.game.events=a.events,b.game.history=a.history,b.room.players=a.room.players,b.room.observers=a.room.observers,console.log("game:leave"+JSON.stringify(a.room)),a.action&&(b.game.action=a.action),a.player&&(b.game.player=a.player),a.opponent&&(b.game.opponent=a.opponent)}),e.on("game:disconnect",function(a){console.log("game:disconnect"),console.log(a),window.location.reload()}),e.on("peer:init",function(){null!==RTCPeerConnection&&(console.log("peer:init"),b.initPeerConnection())}),e.on("peer:receive_candidate",function(a){null!==RTCPeerConnection&&(console.log("peer:candidate has been received"),b.peer.connection.addIceCandidate(new RTCIceCandidate(a.candidate)))}),e.on("peer:receive_offer",function(a){null!==RTCPeerConnection&&(console.log("peer:offer has been received"),b.peer.connection.setRemoteDescription(new RTCSessionDescription(a.sdp)),b.peer.connection.createAnswer(function(a){b.peer.connection.setLocalDescription(a),e.emit("peer:send_answer",{room:GLOBAL.ROOM,sdp:a})}))}),e.on("peer:receive_answer",function(a){null!==RTCPeerConnection&&(console.log("peer:answer has been received"),b.peer.connection.setRemoteDescription(new RTCSessionDescription(a.sdp)))}),b.$on("$destroy",function(){e.destroy()})}),app.directive("dropdownToggle",["$document",function(a){var b=null,c=angular.noop;return{restrict:"CA",link:function(d,e){e.parent().bind("click",function(){c()}),e.bind("click",function(d){var f=e===b;d.preventDefault(),d.stopPropagation(),b&&c(),f||(e.parent().addClass("open"),b=e,c=function(d){d&&(d.preventDefault(),d.stopPropagation()),a.unbind("click",c),e.parent().removeClass("open"),c=angular.noop,b=null},a.bind("click",c))})}}}]);